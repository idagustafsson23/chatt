<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:p="http://primefaces.org/ui">

<h:head>
	<h:outputStylesheet name="grid/grid.css" library="primefaces" />
	<title>Chat</title>
	
	<script type="text/javascript" language="javascript">
	var wsocket;
	var serviceLocation = "ws://localhost:8080/chatt/chat/";
	
	var $nickName;
	var $message;
	var $chatWindow;
	var $userWindow;
	
	function onMessageReceived(evt) {
		console.log("msgRecieved");
		var msg = JSON.parse(evt.data); // native API
		var $messageLine = $('<tr><td class="received">' + msg.received
				+ '</td><td class="user label label-info">' + msg.sender
				+ '</td><td class="message badge">' + msg.message
				+ '</td></tr>'); 
		var $users = $('<tr><td>' + msg.users + '</td></tr>');
		console.log(msg.users);
		$userWindow.append($users);
		$chatWindow.append($messageLine);
	}
	
	function sendMessage() {
		var msg = '{"message":"' + $message.val() + '", "sender":"'
				+ $nickName.val() + '", "received":""}';
		wsocket.send(msg);
		$message.val('').focus();
	}
	
	function sendTest() {
		console.log("form skickat");
		sendMessage();
	}
	
	$(document).ready(function() {
		console.log("document.ready körs iaf...");
		$nickName = $('#userName');
		console.log("Användare: " + $nickName.val());
		$message = $('#message');
		$chatWindow = $('#response');
		$userWindow = $('#userWindow');
		
		//från connectToChatServer
		console.log("ansluten!");
		wsocket = new WebSocket(serviceLocation);
		wsocket.onmessage = onMessageReceived;
		
	});
	$('#btnConnect').click(function(){
		console.log("klick!");
	});
	
	$('#do-chat').submit(function(evt) {
		console.log("form skickat");
		evt.preventDefault();
		sendMessage();
	});
	
	</script>
</h:head>
<h:body>
	<div class="ui-g">
		<div class="ui-g-8 ui-g-nopad">
			<div class="ui-g-12" style="background-color: green">
				<!-- Chatten! -->
				<table id="response"></table>
			</div>
			<div class="ui-g-12" style="background-color: blue">
				<div class="controls">
					<form id="do-chat" onsubmit="return false">
						
						<p:inputText id="message" />
						<button id="btnTest" onclick="sendTest()">hej!</button>
						<input type="submit" value="Send" />
					</form>
				</div>
			</div>
		</div>
		<div class="ui-g-4">
			<table id="userWindow"></table>
			<!-- lista av medlemmar -->
		</div>
	</div>
	<h:inputHidden id="userName" value="#{loginBean.loggedInUser.userName}"></h:inputHidden>

</h:body>
</html>